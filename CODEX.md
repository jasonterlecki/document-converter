# CODEX

## Purpose
DocMorph Web is a browser-only document converter for Markdown, LaTeX, and Word (.docx). It uses a shared intermediate representation (IR) to keep conversions deterministic and testable.

## Repository map
- `packages/core`: IR types, parsers, serializers, and unit tests.
- `packages/web`: React + Vite UI, workers, and web adapters.
- `tsconfig.base.json`: shared TypeScript settings.
- `.eslintrc.cjs`, `.prettierrc.cjs`: lint/format defaults.

## Key entry points
- `packages/core/src/index.ts`: public exports for the core library.
- `packages/core/src/ir/index.ts`: IR types, validators, and normalization.
- `packages/core/src/markdown/index.ts`: Markdown parse/serialize entry.
- `packages/core/src/latex/index.ts`: LaTeX parse/serialize entry.
- `packages/core/src/docx/index.ts`: Docx parse/serialize entry.
- `packages/web/src/main.tsx`: web app entry.
- `packages/web/src/app/App.tsx`: initial UI shell.
- `packages/web/src/workers/conversionWorker.ts`: conversion worker handling format pairs.
- `packages/web/src/adapters/conversionWorker.ts`: worker client adapter for UI use.
- `packages/web/src/app/samples.ts`: sample document definitions for the UI.

## Data model
- IR models documents as blocks and inlines in `packages/core/src/ir/types.ts`.
- Validation helpers live in `packages/core/src/ir/validators.ts`.
- Normalization (merge adjacent text nodes) lives in `packages/core/src/ir/normalize.ts`.
- IR versioning is tracked via `IR_VERSION` in `packages/core/src/ir/version.ts`.

## Converters
- Markdown converters live in `packages/core/src/markdown/parse.ts` and `packages/core/src/markdown/serialize.ts`.
- Fixtures for Markdown tests are under `packages/core/test/fixtures/markdown/`.
- LaTeX converters live in `packages/core/src/latex/parse.ts` and `packages/core/src/latex/serialize.ts`.
- Fixtures for LaTeX tests are under `packages/core/test/fixtures/latex/`.
- Docx converters live in `packages/core/src/docx/parse.ts` and `packages/core/src/docx/serialize.ts`.
- Docx fixtures are under `packages/core/test/fixtures/docx/` (generated by `packages/core/test/helpers/generate-docx-fixtures.mjs`).
- Docx parsing uses Buffer when running in Node tests.
- Docx parsing falls back to raw text extraction if HTML conversion is empty.
- Docx parsing accepts Node Buffers directly for test fixtures.
- Docx HTML parsing wraps fragments in a root container before mapping blocks.
- Docx serialization renders links as "label (url)" text and images as placeholders.
- Docx ordered lists use numbering config with decimal levels.

## Tests
- Round-trip “shape” tests live in `packages/core/test/roundtrip.*.test.ts`.
- Web smoke tests live in `packages/web/test/smoke.test.ts`.

## Workflows and conventions
- Use pnpm workspaces (see root packageManager version).
- Keep conversions browser-compatible; no server dependencies.
- Update `CHANGELOG.md` and `CODEX.md` on every change.
- Commit after each change; do not push.

## Web fixtures
- Web samples import core fixtures via Vite (`packages/web/src/app/samples.ts`).
- Vite dev server allows reading sibling package files in `packages/` via `packages/web/vite.config.ts`.
- Vite resolves `@docmorph/core` to source for tests via an alias in `packages/web/vite.config.ts`.
- Worker conversion imports lazy-load docx modules to avoid DOM globals when not needed.
- Vite resolves @docmorph/core subpaths via explicit aliases in `packages/web/vite.config.ts`.
- Worker imports core modules via relative source paths for Vite worker compatibility.

## Web UI
- Output pane supports downloads for Markdown, LaTeX (.tex), and Docx.

## Constraints and non-goals
- Best-effort conversion; no LaTeX macro expansion or advanced Word features.
- No PDF support.
